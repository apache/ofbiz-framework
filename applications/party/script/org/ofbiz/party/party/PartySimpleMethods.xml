<?xml version="1.0" encoding="UTF-8" ?>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<simple-methods xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xsi:noNamespaceSchemaLocation="http://www.ofbiz.org/dtds/simple-methods.xsd">
    <simple-method method-name="updateAVSOverride" short-description="Create/Update The AVS Override String">
        <make-value value-name="lookupPKMap" entity-name="PartyIcsAvsOverride"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key entity-name="PartyIcsAvsOverride" map-name="lookupPKMap" value-name="lookedUpValue"/>
        <if-not-empty map-name="lookedUpValue" field-name="partyId">
            <set-nonpk-fields map-name="parameters" value-name="lookedUpValue"/>
            <store-value value-name="lookedUpValue"/>
        </if-not-empty>
        <if-empty map-name="lookedUpValue" field-name="partyId">
            <set-nonpk-fields map-name="parameters" value-name="lookupPKMap"/>
            <create-value value-name="lookupPKMap"/>
        </if-empty>
    </simple-method>

    <simple-method method-name="deleteAVSOverride" short-description="Delete The AVS Override String">
        <make-value value-name="lookupPKMap" entity-name="PartyIcsAvsOverride"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key entity-name="PartyIcsAvsOverride" map-name="lookupPKMap" value-name="lookedUpValue"/>
        <if-not-empty map-name="lookedUpValue" field-name="partyId">
            <remove-value value-name="lookedUpValue"/>
        </if-not-empty>
    </simple-method>

    <simple-method method-name="ensureNaPartyRole" short-description="Ensure Party is in _NA_ or the specified Role" login-required="false">
        <!-- must have a partyId, partyIdFrom, or partyIdTo in the parameters map, should be called through different service defs for each one -->
        <if-not-empty field-name="parameters.partyId">
            <set field="lookupPKMap.partyId" from-field="parameters.partyId"/>
            <else>
                <if-not-empty field-name="parameters.partyIdFrom">
                    <set field="lookupPKMap.partyId" from-field="parameters.partyIdFrom"/>
                    <else>
                        <if-not-empty field-name="parameters.partyIdTo">
                            <set field="lookupPKMap.partyId" from-field="parameters.partyIdTo"/>
                        </if-not-empty>
                    </else>
                </if-not-empty>
            </else>
        </if-not-empty>

        <if-empty field-name="parameters.roleTypeId">
            <set field="lookupPKMap.roleTypeId" value="_NA_"/>
        <else>
            <set from-field="parameters.roleTypeId" field="lookupPKMap.roleTypeId"/>
        </else>
        </if-empty>
        <find-by-primary-key entity-name="PartyRole" map-name="lookupPKMap" value-name="lookedUpValue"/>
        <if-empty field-name="lookedUpValue">
            <make-value value-name="newValue" entity-name="PartyRole" map-name="lookupPKMap"/>
            <create-value value-name="newValue"/>
        </if-empty>
    </simple-method>

    <simple-method method-name="createPersonAndUserLogin" short-description="Creates a person and userlogin" login-required="false">
        <set-service-fields service-name="createUserLogin" map-name="parameters" to-map-name="createUlInMap"/>

        <set-service-fields service-name="createPerson" map-name="parameters" to-map-name="createPersonCtx"/>
        <call-service service-name="createPerson" in-map-name="createPersonCtx">
            <result-to-field result-name="partyId" map-name="createUlInMap"/>
        </call-service>

        <!-- call the service with the system account to get around security constraints for this special create -->
        <entity-one entity-name="UserLogin" value-name="createUlInMap.userLogin" auto-field-map="false">
            <field-map field-name="userLoginId" value="system"/>
        </entity-one>
        
        <call-service service-name="createUserLogin" in-map-name="createUlInMap"/>
        <entity-one entity-name="UserLogin" value-name="newUserLogin"/>

        <field-to-result field-name="newUserLogin"/>
        <field-to-result field-name="createUlInMap.partyId" result-name="partyId"/>
    </simple-method>
</simple-methods>
